## 자바 직렬화 2편 실무편
출처 [우아한형제들 기술블로그](http://woowabros.github.io/experience/2017/10/17/java-serialize2.html)

실제 업무에 직렬화를 적용하며 신경써야할 부분 몇가지.

#### 역질렬화시 클래스 구조 변경문제
원래 클래스에 멤버변수 하나만 추가되어도 java.io.InvalidClassException 예외가 발생합니다.
예외 메시지를 읽어보면 serialVersionUID의 정보가 일치하지 않기 때문에 발생한 것을 알 수 있다.

suid는 직접 기술하지 않아도 내부적으로 SUID 정보가 추가된다.
내부 값도 자바 직렬화 스펙 드대로 자동으로 생성된 클래스의 해쉬값이라는 것을 확인할 수 있다.

*그럼 어떤 형태가 좋을까?*

"조금이라도 역직렬화 대상 클래스 구조가 바뀌면 에러 발생해야 된다." 정도의 민감한 시스템이 아닌
이상은 클래스를 변경할 때 직접 serialVersionUID 값을 관리 해주어야 클래스 변경시 혼란을 줄일 수 있습니다.

### SUID를 동일하게 하였더라고
#### 1. 멤버 변수명은 같은데 멤버 변수 타입이 바뀔 때
String 를 StringBuilder 타입으로 바꾸거나
primitive 타입인 int 를 long 로 바꾸면 ClassCastException 예러가 발생한다.
자바 직렬화는 상당히 타입이 엄격하다는 것을 알 수 있다.


#### 2. 직렬화 자바 데이터에 존재하는 멤버변수가 없애거나 추가햇을때
에러는 발생하지 않지만. 값자체만 없어진다.


##### 자바 직렬화를 사용할 때 클래스 구조변경시 어떤 부분을 확인해야 할지 정리해보겠습니다.
- 특별한 문제 없으면 자바 직렬화 버전 serialVersionUID의 값은 개발시 직접 관리해야 합니다.
- SUID 값이 동일하면 멤버변수 및 메서드 추가는 크게 문제가 없습니다. 그리고 멤버변수 제거 및
이름 변경은 발생하지 않지만 데이터는 누락됩니다.
- 역직렬화 대상 클래스의 멤버변수 타입변경을 지양해야 합니다. 타입이 엄격합니다.
- 외부에 장기간 저장될 정보는 자바 직렬화 사용을 지양해야 합니다. 역직렬화 대상의 클래스가
언제 변경이 일어나지 모르는 환경에서 긴시간 동안 외부에 존재했던 직렬화된 데이터는 쓰레기가 될 가능성이 높습니다.
 언제 예외가 발생할지 모르는 지뢰 시스템이 될 수도 있습니다.
- 개발자가 직접 컨트롤이 간으한 클래스의 객체가 아닌 클래스의 객체에 대한 직렬화는 지양해야 합니다.
#### 결론
자바 직렬화를 사용할 때에는 될수 있으면 자주 변경되는 클래스의 객체는 사용 안하는 것이 좋습니다.
특히 역직렬화가 되지 않을때와 같은 예외처리는 기본적으로 해두는 것을 추천합니다.


### 용량문제
자바 직렬화시에는 기본적으로 타입에 대한 정보 등 클래스의 메타정보도 가지고 있기때문에 상대적으로 다른 포맷에 비해서 용량이 큰 문제가 있습니다.

특히 클래스의 구조가 거대해지게 되면 용량 차이가 커지게 됩니다.
직렬화하게 되면 모든 클래스에 대한 머타정보를 가지고 있기 때문에 용량이 비대해지게 됩니다.
그래서 JSON 같은 최소의 메타정보만 가지고 있으면 테스트로 된 포맷보다 같은 데이터에서 
최소 2배 최대 10배 이상의 크기를 가질 수 있습니다.

#### 용량문제 결론
일반 사용자를 대상으로 하는 B2C 와 같은 시스템에서 자바 직렬화 정보를 외부 캐시 서버에 저장할 때에는 비효율적인 문제를 가지고 있습니다.(용량 크기에 따른 네트워크 비용과 캐시서버 비용)
새롭게 스타트하는 서비스 같은 경우에는 생산성으로 위해서 자바 직렬화를 그대로 이용한다고 해도
트래픽이 지속적으로 증가할 때에는 JSON 형태 또는 다른 형태의 직렬화로 바꿔주는 것 고려해보시길 바랍니다.

### 호환성 이야기
자바 직렬화를 이용해서 외부 데이터를 저장하게 되면 제일 큰 아쉬움이 바로 자바에서만 
사용할 수 있으며, 읽을 수 있는 문제 였습니다.
만약 JSON으로 저장되어 있다면 MYSQL이나 REDIS 등 추가 라이브러리를 통해 조회도 가능하며
다른 언어를 통해서도 탐색 및 조작이 가능합니다.

그리고 화자가 하고하는 말은 " 긴 시간동안 외부에 저장하는 의미있는 데이터들은 자바 직렬화를 사용하지 말자." 이다.

## 결론
자바 직렬화는 장점이 많은 기술이지만 단점도 많습니다.
문제는 이 기술의 단점을 보완하기 힘든 형태로 되어있기 때문에 사용시 제약이 많습니다.
그래서 화자는 아래와 같은 규칙을 지키라고 한다.
1. 외부 저장소로 저장되는 데이터는 짧은 만료시간의 데이터를 제외하고 자바 직렬화의 사용을 지양합니다.
2. 역직렬화시 반드시 예외가 생긴다는 것을 생각하고 개발합니다.
3. 자주 변경되는 비지니스적인 데이터를 자바 직령화로 사용하지 않습니다.
4. 긴 만료 시간을 가지는 데이터는 JSON 등 다른 포맷을 사용하여 저장합니다.


